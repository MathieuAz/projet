<!DOCTYPE html>
<html>
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.2.3/backbone-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.2/handlebars.min.js"></script>

<link rel="stylesheet" type="text/css" href="styles.css" charset="utf-8">

<!-- TEMPLATES -->
<script type="text/template" id="book-template">
    <img src="{{this.cover}}" alt="{{this.title}}">
    <p>{{this.title}}</p>
    <p class="price-book">{{this.price}} EUROS</p>
</script>

<script type="text/template" id="panier-template">
    <p>{{this.title}} <span class="prix">{{this.price}}€</span><span class="quantite">X{{this.quantite}}</span></p>
</script>

<script type="text/template" id="prix-template">
    <p>Prix total: <span id="prix-total">{{this.prixTotal}}</span>€</p>
    <p id="prix-reduction">Prix avec réduction: {{this.prixReduction}}€</p>
</script>
<!-- FIN TEMPLATES -->
</head>

<body>
<div class="list-content">
    <h2>Sélection de nos livres</h2>
    <ul id="list"></ul>
</div>
<div id="panier" class="panier">
    <h2>Panier</h2>
    <div id="books-selected" class="books-selected"></div>
    <div id="prix-panier">
        <p>Prix total: <span id="prix-total">0</span>€</p>
    </div>
    <button id="vider-panier" class="vider-panier">Vider le panier</button>
</div>

<script>
(function($){

var PubSub = function() {
    this.events = _.extend({}, Backbone.Events);
};

//MODEL
var Book = Backbone.Model.extend({
    defaults: {'quantite': 1}
});


//COLLECTIONS
var BooksList = Backbone.Collection.extend({
    model: Book,
    url: 'http://henri-potier.xebia.fr/books'
});

var PanierList = Backbone.Collection.extend({});

var PanierPrix = Backbone.Collection.extend({});


//VIEWS
var BookListView = Backbone.View.extend({
    el: '#list',
    collection: new BooksList(),

    initialize: function() {debugger;
        _.bindAll(this, 'render', 'processBook');
        this.collection.fetch({
            success: this.render
        });
    },

    render: function() {
        _.each(this.collection.models, this.processBook, this);
        return this;
    },

    processBook: function(book) {
        var childBookItemView = new BookItemView({model: book});
        childBookItemView.render();
        this.$el.append(childBookItemView.el);
    }
});

var BookItemView = Backbone.View.extend({
    template: $('#book-template').html(),
    tagName: 'li',
    initialize: function() {
        _.bindAll(this, 'render', 'publish');
    },

    events: {
        'click p': 'publish'
    },

    render: function() {
        var source = this.template,
            template = Handlebars.compile(source),
            html = template(this.model.toJSON());
        this.$el.html(html);
        return this;
    },

    publish: function() {
        pubSub.events.trigger('book:clicked', this.model);
    }
});

var PanierListView = Backbone.View.extend({
    el: '#panier',
    template: $('#panier-template').html(),
    collection: new PanierList(),
    events: {
        'click #vider-panier': 'cleanPanier'
    },

    initialize: function() {
        _.bindAll(this, 'render', 'renderBook', 'addBook', 'cleanPanier');
        pubSub.events.on('book:clicked', this.addBook, this);
    },

   render: function() {
        this.$el.find('#books-selected').empty();

        _.each(this.collection.models, this.renderBook, this);

        pubSub.events.trigger('book:add', this.collection);

        return this;
    },

    renderBook: function(book) {
        var source = this.template,
            template = Handlebars.compile(source),
            html = template(book.toJSON());
        this.$el.find('#books-selected').append(html);
        return this;
    },

    addBook: function(book) {
        var modelExist = false,
            cid;

        _.each(this.collection.models, function(value) {
            cid = value.cid;
            if (cid === book.cid) {
                modelExist = true;
            }
        });

        if (!modelExist) {
           this.model = book;
           this.collection.add(this.model);
        } else {
            var model = _.findWhere(this.collection.models, {cid: book.cid});
            model.set('quantite', model.get('quantite') + 1);
        }

        this.render();
    },

    cleanPanier: function() {
        this.collection.remove(this.collection.models);
        this.$el.find('#books-selected, #prix-reduction').empty();
        this.$el.find('#prix-total').html('0');
    }
});

var PrixPanierView = Backbone.View.extend({
    el: '#prix-panier',
    template: $('#prix-template').html(),
    collection: new PanierPrix(),
    initialize: function() {
        _.bindAll(this, 'render', 'processPrix')
        pubSub.events.on('book:add', this.processPrix, this);
    },
    processPrix: function(collection) {
        this.collection.reset(collection.models);
        var isbnArray = [],
            price = 0;

        _.each(this.collection.models, function(value) {
            isbnArray.push(value.get('isbn'));
            price += value.get('price') * value.get('quantite');
        });

        this.$el.find('#prix-total').html(price);

        this.collection.url = 'http://henri-potier.xebia.fr/books/'+ isbnArray.toString() + '/commercialOffers';

        this.collection.fetch({
            success: this.render
        });
    },
    render: function() {
        var offers = this.collection.models[0].get('offers');

        if (offers) {
            var prixTotal = this.$el.find('#prix-total').html(),
                prixPercentage,
                prixMinus,
                prixSlice,
                prixArray = [];

            _.each(offers, function(value) {
                switch(value.type) {
                    case 'percentage':
                        prixPercentage = prixTotal - (prixTotal * (value.value / 100));
                        prixArray.push(prixPercentage);
                        break;
                    case 'minus':
                        prixMinus = prixTotal - value.value;
                        prixArray.push(prixMinus);
                        break;
                    case 'slice':
                        if (prixTotal > value.sliceValue) {
                            var division = prixTotal / value.sliceValue;
                            prixSlice = prixTotal - (value.value * parseInt(division, 10));
                            prixArray.push(prixSlice);
                        }
                        break;
                }
            });

            var prixArraySort = prixArray.sort(function(a, b) {
                return a - b;
            });

            var prixReduction = prixArraySort[0];

            this.collection.models[0].set('prixTotal', prixTotal);
            this.collection.models[0].set('prixReduction', prixReduction);

            var source = this.template,
                template = Handlebars.compile(source),
                html = template(this.collection.models[0].toJSON());
            this.$el.html(html);
        }
    }
});

//INSTANTIATE VIEWS
var pubSub = new PubSub();
var bookListView = new BookListView();
var panierListView = new PanierListView();
var prixListView = new PrixPanierView();

})(jQuery);

</script>
</body>
</html>